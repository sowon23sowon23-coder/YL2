<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Share Love Joy Hope</title>
  <style>
    :root{
      --bg1:#f6e7eb;
      --bg2:#f3cfd8;
      --ink:#3b2b31;
      --muted:#7a6a71;
      --brand:#b12b62;
      --btn:#5a2c57;
      --shadow: 0 10px 24px rgba(0,0,0,.12);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#eee;
      display:flex;
      justify-content:center;
      padding:22px;
      color:var(--ink);
    }

    /* single flow phone */
    .phone{
      width: 340px;
      max-width: 95vw;
      height: 680px;
      border-radius: 16px;
      background: linear-gradient(var(--bg1), var(--bg2));
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,.06);
      overflow:hidden;
      position:relative;
    }

    .page{
      position:absolute;
      inset:0;
      padding: 22px 18px;
      display:none;
    }
    .page.active{ display:block; }

    .top{ text-align:center; margin-bottom:14px; }
    .pill{
      display:inline-block;
      padding:10px 16px;
      border-radius:14px;
      background: rgba(255,255,255,.7);
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
      color: var(--brand);
      font-weight:900;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    /* main */
    .uploadBox{
      margin: 18px auto 12px;
      width:100%;
      height:220px;
      border-radius:16px;
      background: rgba(255,255,255,.65);
      border: 2px solid rgba(177,43,98,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .uploadBox img{ width:100%; height:100%; object-fit:cover; display:none; }
    .uploadBox .hint{
      position:absolute;
      text-align:center;
      padding: 0 12px;
      color: rgba(59,43,49,.55);
      font-size:13px;
    }

    .row{ margin:10px 0; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="text"]{
      width:100%;
      height:38px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      padding:0 14px;
      background: rgba(255,255,255,.85);
      outline:none;
    }
    .smallBtn{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .smallBtn input{ display:none; }

    .btn{
      width:100%;
      height:44px;
      border:none;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.4px;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      margin-top:10px;
      background: var(--btn);
      color:#fff;
    }
    .btn.ghost{
      background: rgba(255,255,255,.75);
      color: rgba(59,43,49,.85);
      border: 1px solid rgba(0,0,0,.12);
      box-shadow:none;
    }

    /* gallery */
    .backLink{
      display:inline-block;
      font-size:12px;
      color: rgba(59,43,49,.7);
      cursor:pointer;
      user-select:none;
      margin: 2px 0 10px;
    }
    .galleryScroll{
      height:560px;
      overflow-y:auto;
      padding-right:6px;
    }
    .heartStack{
      position:relative;
      height:1200px;
      width:100%;
    }

    /* heart flip card */
    .heartCard{
      position:absolute;
      perspective: 900px;
      cursor:pointer;
      user-select:none;
    }
    .heartInner{
      width:100%;
      height:100%;
      position:relative;
      transform-style: preserve-3d;
      transition: transform 700ms ease;
    }
    .heartCard.showBack .heartInner{ transform: rotateY(180deg); }

    .heartFace{
      position:absolute;
      inset:0;
      backface-visibility:hidden;
      filter: drop-shadow(0 12px 14px rgba(0,0,0,.14));
    }
    .heartBack{ transform: rotateY(180deg); }

    /* heart mask */
    .heartShape{
      width:100%;
      height:100%;
      background: rgba(255,255,255,.92);
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 18px;
      -webkit-mask-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 90'><path d='M50 82C25 66 8 51 8 32C8 19 18 10 31 10C39 10 46 14 50 20C54 14 61 10 69 10C82 10 92 19 92 32C92 51 75 66 50 82Z' fill='black'/></svg>");
      -webkit-mask-size:100% 100%;
      -webkit-mask-repeat:no-repeat;
      mask-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 90'><path d='M50 82C25 66 8 51 8 32C8 19 18 10 31 10C39 10 46 14 50 20C54 14 61 10 69 10C82 10 92 19 92 32C92 51 75 66 50 82Z' fill='black'/></svg>");
      mask-size:100% 100%;
      mask-repeat:no-repeat;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .heartShape img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    /* centered text inside heart */
    .heartTextWrap{
      width: 78%;
      height: 78%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:8px;
      padding: 8px 6px;
    }
    .heartNick{
      font-weight:900;
      line-height:1.1;
      color: rgba(59,43,49,.92);
      font-size: 13px;
      max-width: 100%;
      word-break: break-word;
    }
    .heartMsg{
      font-weight:600;
      color: rgba(59,43,49,.82);
      line-height:1.18;
      max-width: 100%;
      word-break: break-word;
      white-space: pre-wrap;
    }

    /* detail */
    .overlay{
      position:absolute;
      inset:0;
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(6px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .detailCard{
      width:92%;
      background: rgba(255,255,255,.92);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
      position:relative;
    }
    .closeX{
      position:absolute;
      right:10px;
      top:10px;
      width:28px;
      height:28px;
      border-radius:999px;
      border:none;
      background: rgba(0,0,0,.08);
      cursor:pointer;
      font-weight:900;
    }
    .detailImg{ height:280px; width:100%; background:#eee; overflow:hidden; }
    .detailImg img{ width:100%; height:100%; object-fit:cover; display:block; }
    .detailBody{ padding:12px 14px 14px; text-align:center; }
    .tag{ font-size:11px; letter-spacing:.5px; color: rgba(59,43,49,.6); margin-bottom:8px; }
    .fromPill{
      margin:0 auto 10px;
      width:70%;
      height:36px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      background: rgba(255,255,255,.85);
      font-weight:900;
      color: rgba(59,43,49,.85);
      font-size:12px;
    }
    .avatarDot{
      width:18px;height:18px;border-radius:999px;background: rgba(177,43,98,.18);
      display:inline-block; position:relative;
    }
    .avatarDot::after{
      content:"";
      position:absolute; left:50%; top:52%;
      transform: translate(-50%,-50%);
      width:8px;height:8px;border-radius:999px;
      background: rgba(177,43,98,.55);
    }
    .detailMsg{ font-size:12px; color: rgba(59,43,49,.85); line-height:1.35; margin-bottom:10px; padding:0 8px; white-space:pre-wrap; }
    .date{ font-size:11px; color: rgba(59,43,49,.55); padding-bottom:6px; }

    /* SCREEN MODE */
    #screen{
      width:min(1100px, 98vw);
      height:min(720px, 92vh);
      border-radius:18px;
      background: linear-gradient(var(--bg1), var(--bg2));
      box-shadow: var(--shadow);
      border:1px solid rgba(0,0,0,.08);
      padding:22px;
      display:none;
      position:relative;
      overflow:hidden;
    }
    .screenTop{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .screenTitle{
      font-weight:900;
      color: var(--brand);
      font-size:26px;
      letter-spacing:.2px;
    }
    .screenSub{
      color: rgba(59,43,49,.65);
      font-weight:700;
      font-size:14px;
    }
    .slideWrap{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      height: calc(100% - 60px);
      align-items:stretch;
    }
    #screenImg{
      width:100%;
      height:100%;
      object-fit:contain;
      background: rgba(255,255,255,.55);
      border-radius:16px;
      border:1px solid rgba(0,0,0,.08);
    }
    .screenText{
      background: rgba(255,255,255,.7);
      border-radius:16px;
      border:1px solid rgba(0,0,0,.08);
      padding:18px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:12px;
    }
    .screenNick{
      font-size:28px;
      font-weight:900;
      color: rgba(59,43,49,.92);
    }
    .screenMsg{
      font-size:22px;
      font-weight:700;
      color: rgba(59,43,49,.85);
      white-space:pre-wrap;
      line-height:1.25;
    }
    .screenDate{
      margin-top:8px;
      color: rgba(59,43,49,.6);
      font-weight:700;
      font-size:14px;
    }
    .screenHint{
      position:absolute;
      right:16px;
      bottom:14px;
      color: rgba(59,43,49,.55);
      font-size:12px;
      font-weight:700;
    }
  </style>
</head>

<body>

  <!-- SCREEN MODE UI -->
  <section id="screen">
    <div class="screenTop">
      <div class="screenTitle">Share Love Joy Hope</div>
      <div class="screenSub">Scan QR to upload</div>
    </div>

    <div class="slideWrap">
      <img id="screenImg" alt="slide"/>
      <div class="screenText">
        <div id="screenNick" class="screenNick"></div>
        <div id="screenMsg" class="screenMsg"></div>
        <div id="screenDate" class="screenDate"></div>
      </div>
    </div>

    <div class="screenHint">Press F11 for fullscreen</div>
  </section>

  <!-- PHONE UI -->
  <div class="phone">

    <!-- MAIN -->
    <section class="page active" id="page-main">
      <div class="top">
        <div class="pill">Share Love Joy Hope</div>
        <div class="sub">Share your own<br/>LOVE · JOY · HOPE moment here.</div>
      </div>

      <div class="uploadBox">
        <img id="previewImg" alt="preview" />
        <div class="hint" id="previewHint">Upload your image</div>
      </div>

      <div class="row">
        <label>Image</label>
        <label class="smallBtn">
          ⬆ Upload image
          <input type="file" id="fileInput" accept="image/*" />
        </label>
      </div>

      <div class="row">
        <label>Nickname (10 chars max)</label>
        <input type="text" id="nickInput" maxlength="10" placeholder="Please enter a nickname" />
      </div>

      <div class="row">
        <label>Description (30 chars max)</label>
        <input type="text" id="msgInput" maxlength="30" placeholder="Please write a short description" />
      </div>

      <button class="btn" id="submitAndGo">♡ CLICK TO UPLOAD ♡</button>
      <button class="btn ghost" id="justGoGallery">VIEW THE GALLERY</button>
    </section>

    <!-- GALLERY -->
    <section class="page" id="page-gallery">
      <div class="top">
        <div class="pill" style="font-size:12px;padding:10px 14px;">
          Share your own<br/>LOVE · JOY · HOPE moment here.
        </div>
      </div>

      <div class="backLink" id="backToMain">← BACK</div>

      <div class="galleryScroll">
        <div class="heartStack" id="heartStack"></div>
      </div>
    </section>

    <!-- DETAIL -->
    <section class="page" id="page-detail">
      <div class="top">
        <div class="pill" style="font-size:12px;padding:10px 14px;">
          Share your own<br/>LOVE · JOY · HOPE moment here.
        </div>
      </div>

      <div class="overlay">
        <div class="detailCard">
          <button class="closeX" id="closeDetail">X</button>
          <div class="detailImg"><img id="detailImg" alt="detail"/></div>
          <div class="detailBody">
            <div class="tag">FROM</div>
            <div class="fromPill"><span class="avatarDot"></span><span id="detailNick">Nick</span></div>
            <div class="detailMsg" id="detailMsg">Message</div>
            <div class="date" id="detailDate">YYYY / MM / DD</div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- ✅ Supabase SDK: script tag는 반드시 이렇게 "닫힘"이 있어야 해 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /***********************
     * Supabase Config
     ***********************/
    const SUPABASE_URL = "https://jhkeupkswnqeytroliwn.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_dCtuDm5n0rmgxcouaWY55Q_2PbiVAYA";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************
     * Supabase Storage Upload
     ***********************/
    async function uploadImageToSupabase(file){
      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const path = `public/${Date.now()}_${crypto.randomUUID()}.${ext}`;

      const { error: upErr } = await supabase.storage
        .from("yl-images")
        .upload(path, file, { cacheControl: "3600", upsert: false });

      if (upErr) throw upErr;

      const { data } = supabase.storage.from("yl-images").getPublicUrl(path);
      return data.publicUrl;
    }

    /***********************
     * Supabase DB (yl_entries)
     ***********************/
    async function saveEntryToDB({ nickname, description, imageUrl }) {
      const { error } = await supabase
        .from("yl_entries")
        .insert([{
          nickname,
          description: description || null,
          image_url: imageUrl
        }]);
      if (error) throw error;
    }

    async function fetchEntriesFromDB(limit = 60) {
      const { data, error } = await supabase
        .from("yl_entries")
        .select("id, nickname, description, image_url, created_at")
        .order("created_at", { ascending: false })
        .limit(limit);

      if (error) throw error;
      return data || [];
    }

    function mapDbRowToEntry(row){
      return {
        id: row.id,
        nick: row.nickname,
        msg: row.description || "",
        imgUrl: row.image_url,
        createdAt: new Date(row.created_at).getTime()
      };
    }

    /***********************
     * Elements
     ***********************/
    const pageMain    = document.getElementById("page-main");
    const pageGallery = document.getElementById("page-gallery");
    const pageDetail  = document.getElementById("page-detail");

    const fileInput   = document.getElementById("fileInput");
    const previewImg  = document.getElementById("previewImg");
    const previewHint = document.getElementById("previewHint");
    const nickInput   = document.getElementById("nickInput");
    const msgInput    = document.getElementById("msgInput");

    const submitAndGo   = document.getElementById("submitAndGo");
    const justGoGallery = document.getElementById("justGoGallery");
    const backToMain    = document.getElementById("backToMain");

    const heartStack = document.getElementById("heartStack");

    const closeDetail = document.getElementById("closeDetail");
    const detailImg   = document.getElementById("detailImg");
    const detailNick  = document.getElementById("detailNick");
    const detailMsg   = document.getElementById("detailMsg");
    const detailDate  = document.getElementById("detailDate");

    // screen
    const isScreenMode = new URLSearchParams(location.search).get("mode") === "screen";
    const screenEl   = document.getElementById("screen");
    const phoneEl    = document.querySelector(".phone");
    const screenImg  = document.getElementById("screenImg");
    const screenNick = document.getElementById("screenNick");
    const screenMsg  = document.getElementById("screenMsg");
    const screenDate = document.getElementById("screenDate");

    /***********************
     * State
     ***********************/
    let entries = [];
    let flipTimer = null;

    // upload state
    let selectedFile = null;
    let currentUploadPreviewUrl = "";

    /***********************
     * Navigation
     ***********************/
    function show(page){
      [pageMain, pageGallery, pageDetail].forEach(p => p.classList.remove("active"));
      page.classList.add("active");
    }

    /***********************
     * Helpers
     ***********************/
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function formatDate(ts){
      const d = new Date(ts);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy} / ${mm} / ${dd}`;
    }

    async function refreshFromDB(){
      const rows = await fetchEntriesFromDB(60);
      entries = rows.map(mapDbRowToEntry);
    }

    /***********************
     * Main: preview
     ***********************/
    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;

      selectedFile = file;

      const previewUrl = await readAsDataURL(file);
      currentUploadPreviewUrl = previewUrl;

      previewImg.src = previewUrl;
      previewImg.style.display = "block";
      previewHint.style.display = "none";
    });

    function readAsDataURL(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /***********************
     * Upload -> Storage -> DB -> Refresh
     ***********************/
    async function handleUploadClick(){
      const nick = nickInput.value.trim();
      const msg  = msgInput.value.trim();

      if(!selectedFile){ alert("Please upload an image."); return; }
      if(!nick){ alert("Please enter a nickname."); return; }
      if(!msg){ alert("Please write a short description."); return; }

      submitAndGo.disabled = true;
      submitAndGo.textContent = "Uploading...";

      try{
        const imageUrl = await uploadImageToSupabase(selectedFile);
        await saveEntryToDB({ nickname: nick, description: msg, imageUrl });

        // reset inputs
        nickInput.value = "";
        msgInput.value = "";
        fileInput.value = "";
        selectedFile = null;
        currentUploadPreviewUrl = "";
        previewImg.style.display = "none";
        previewHint.style.display = "block";

        await refreshFromDB();
        renderGallery();
        show(pageGallery);
      }catch(e){
        console.error(e);
        alert("Upload failed. Check console.");
      }finally{
        submitAndGo.disabled = false;
        submitAndGo.textContent = "♡ CLICK TO UPLOAD ♡";
      }
    }

    /***********************
     * Buttons
     ***********************/
    submitAndGo.addEventListener("click", handleUploadClick);

    justGoGallery.addEventListener("click", async () => {
      try{
        await refreshFromDB();
        renderGallery();
        show(pageGallery);
      }catch(e){
        console.error(e);
        alert("Failed to load gallery.");
      }
    });

    backToMain.addEventListener("click", () => show(pageMain));

    /***********************
     * Detail
     ***********************/
    close
